<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NextPicker News</title>
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1><i class="fas fa-newspaper"></i> NextPicker News</h1>
      <div class="summary-stats">
        <div class="stat">
          <span class="stat-number">{{ summary.total }}</span>
          <span class="stat-label">Total</span>
        </div>
        <div class="stat">
          <span class="stat-number">{{ summary.us }}</span>
          <span class="stat-label">US</span>
        </div>
        <div class="stat">
          <span class="stat-number">{{ summary.kr }}</span>
          <span class="stat-label">KR</span>
        </div>
      </div>
    </header>

    <div class="controls">
      <div class="date-ranges">
        <div class="range-item">
          <i class="fas fa-globe-americas"></i>
          <span>{{ summary.range_us }}</span>
        </div>
        <div class="range-item">
          <i class="fas fa-globe-asia"></i>
          <span>{{ summary.range_kr }}</span>
        </div>
      </div>
      <div class="update-info">
        <div class="last-update">
          <i class="fas fa-clock"></i>
          <span>최종 업데이트: {{ summary.last_update }}</span>
        </div>
        <div class="next-update">
          <i class="fas fa-calendar-alt"></i>
          <span>다음 수집: 매일 오전 8시 (KST)</span>
        </div>
      </div>
      <button id="refreshBtn" class="refresh-btn" onclick="refreshNews()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <button id="analysisBtn" class="analysis-btn" onclick="showAnalysis()">
        <i class="fas fa-chart-bar"></i> AI 분석용 데이터
      </button>
    </div>

    <div class="news-container">
      <section class="news-section">
        <h2><i class="fas fa-flag-usa"></i> US News ({{ summary.us }})</h2>
        <div class="news-list" id="usNews">
          {% for n in news_us %}
            <article class="news-item">
              <div class="news-header">
                <a href="{{ n.url }}" target="_blank" class="news-title">{{ n.title }}</a>
                <div class="news-meta">
                  <span class="source">{{ n.source }}</span>
                  {% if n.section %}
                    <span class="section-badge {{ n.section }}">{{ n.section|title }}</span>
                  {% endif %}
                  <span class="time">{{ n.published_local_str }} {{ n.local_tz }}</span>
                  <span class="country-badge us">{{ n.country|upper }}</span>
                </div>
              </div>
              {% if n.summary %}
                <p class="news-summary">{{ n.summary[:200] }}{% if n.summary|length > 200 %}...{% endif %}</p>
              {% endif %}
            </article>
          {% endfor %}
        </div>
      </section>

      <section class="news-section">
        <h2><i class="fas fa-flag"></i> KR News ({{ summary.kr }})</h2>
        <div class="news-list" id="krNews">
          {% for n in news_kr %}
            <article class="news-item">
              <div class="news-header">
                <a href="{{ n.url }}" target="_blank" class="news-title">{{ n.title }}</a>
                <div class="news-meta">
                  <span class="source">{{ n.source }}</span>
                  {% if n.section %}
                    <span class="section-badge {{ n.section }}">{{ n.section|title }}</span>
                  {% endif %}
                  <span class="time">{{ n.published_local_str }} {{ n.local_tz }}</span>
                  <span class="country-badge kr">{{ n.country|upper }}</span>
                </div>
              </div>
              {% if n.summary %}
                <p class="news-summary">{{ n.summary[:200] }}{% if n.summary|length > 200 %}...{% endif %}</p>
              {% endif %}
            </article>
          {% endfor %}
        </div>
      </section>
    </div>

    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <p>Loading fresh news...</p>
    </div>
    

  </div>

  <script>
    function refreshNews() {
      const loading = document.getElementById('loading');
      const refreshBtn = document.getElementById('refreshBtn');
      
      loading.classList.remove('hidden');
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
      
      fetch('/api/refresh', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        })
        .catch(error => {
          console.error('Error:', error);
          loading.classList.add('hidden');
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        });
    }


    
    function showAnalysis() {
      const analysisBtn = document.getElementById('analysisBtn');
      
      analysisBtn.disabled = true;
      analysisBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 복사 중...';
      
      fetch('/api/analysis/us-news')
        .then(response => response.json())
        .then(data => {
          // 데이터 유효성 검사
          if (!data || !data.data || !Array.isArray(data.data)) {
            console.error('Invalid data format:', data);
            analysisBtn.disabled = false;
            analysisBtn.innerHTML = '<i class="fas fa-chart-bar"></i> AI 분석용 데이터';
            return;
          }
          
          // 데이터를 문자열로 변환
          const textData = data.data.join('\n');
          
          // 클립보드에 복사
          navigator.clipboard.writeText(textData).then(() => {
            analysisBtn.innerHTML = '<i class="fas fa-check"></i> 복사 완료!';
            setTimeout(() => {
              analysisBtn.disabled = false;
              analysisBtn.innerHTML = '<i class="fas fa-chart-bar"></i> AI 분석용 데이터';
            }, 2000);
          }).catch(() => {
            // 클립보드 복사 실패 시 fallback
            const textArea = document.createElement('textarea');
            textArea.value = textData;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            analysisBtn.innerHTML = '<i class="fas fa-check"></i> 복사 완료!';
            setTimeout(() => {
              analysisBtn.disabled = false;
              analysisBtn.innerHTML = '<i class="fas fa-chart-bar"></i> AI 분석용 데이터';
            }, 2000);
          });
        })
        .catch(error => {
          console.error('Error:', error);
          analysisBtn.disabled = false;
          analysisBtn.innerHTML = '<i class="fas fa-chart-bar"></i> AI 분석용 데이터';
        });
    }
    

  </script>
</body>
</html>
