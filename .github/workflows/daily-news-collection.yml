name: Daily News Collection

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 8ì‹œ (UTC 23:00, í•œêµ­ ì‹œê°„ 8:00)
    - cron: '0 23 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests feedparser python-dateutil
        
    - name: Collect news from Vercel API
      id: collect_news
      run: |
        echo "Starting daily news collection..."
        response=$(curl -s -X POST https://lumina-next-picker.vercel.app/api/refresh)
        echo "News collection completed!"
        echo "response=$response" >> $GITHUB_OUTPUT
        
    - name: Parse news results
      id: parse_results
      run: |
        response='${{ steps.collect_news.outputs.response }}'
        echo "Raw response: $response"
        
        # JSONì—ì„œ ê²°ê³¼ ì¶”ì¶œ
        if echo "$response" | grep -q '"result"'; then
          us_count=$(echo "$response" | grep -o '"US":[0-9]*' | grep -o '[0-9]*')
          kr_count=$(echo "$response" | grep -o '"KR":[0-9]*' | grep -o '[0-9]*')
          total=$((us_count + kr_count))
          
          echo "us_count=$us_count" >> $GITHUB_OUTPUT
          echo "kr_count=$kr_count" >> $GITHUB_OUTPUT
          echo "total=$total" >> $GITHUB_OUTPUT
        else
          echo "us_count=0" >> $GITHUB_OUTPUT
          echo "kr_count=0" >> $GITHUB_OUTPUT
          echo "total=0" >> $GITHUB_OUTPUT
        fi
        
    - name: Send Slack notification
      if: always()
      run: |
        # Slack ë´‡ í† í° (GitHub Secretsì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        SLACK_BOT_TOKEN="${{ secrets.SLACK_BOT_TOKEN }}"
        SLACK_CHANNELS="${{ secrets.SLACK_CHANNELS }}"
        
        if [ -n "$SLACK_BOT_TOKEN" ] && [ -n "$SLACK_CHANNELS" ]; then
          # í˜„ì¬ ì‹œê°„ (í•œêµ­ ì‹œê°„)
          KST_TIME=$(date -d '+9 hours' '+%Y-%m-%d %H:%M:%S KST')
          
          # ë©”ì‹œì§€ êµ¬ì„±
          if [ "${{ job.status }}" == "success" ]; then
            MESSAGE="ğŸ“° *ì¼ì¼ ë‰´ìŠ¤ ìˆ˜ì§‘ ì™„ë£Œ!*\n"
            MESSAGE+="â° ì‹œê°„: $KST_TIME\n"
            MESSAGE+="ğŸ‡ºğŸ‡¸ ë¯¸êµ­ ë‰´ìŠ¤: ${{ steps.parse_results.outputs.us_count }}ê°œ\n"
            MESSAGE+="ğŸ‡°ğŸ‡· í•œêµ­ ë‰´ìŠ¤: ${{ steps.parse_results.outputs.kr_count }}ê°œ\n"
            MESSAGE+="ğŸ“Š ì´ ${{ steps.parse_results.outputs.total }}ê°œ ê¸°ì‚¬ ìˆ˜ì§‘\n"
            MESSAGE+="ğŸ”— <https://lumina-next-picker.vercel.app/news|ë‰´ìŠ¤ í™•ì¸í•˜ê¸°>"
          else
            MESSAGE="âŒ *ë‰´ìŠ¤ ìˆ˜ì§‘ ì‹¤íŒ¨*\n"
            MESSAGE+="â° ì‹œê°„: $KST_TIME\n"
            MESSAGE+="ğŸ”— <https://lumina-next-picker.vercel.app/news|ë‰´ìŠ¤ í™•ì¸í•˜ê¸°>"
          fi
          
          # ì—¬ëŸ¬ ì±„ë„ì— ë©”ì‹œì§€ ì „ì†¡
          IFS=',' read -ra CHANNELS <<< "$SLACK_CHANNELS"
          for channel in "${CHANNELS[@]}"; do
            # ì±„ë„ëª… ì•ë’¤ ê³µë°± ì œê±°
            channel=$(echo "$channel" | xargs)
            
            echo "Sending message to channel: $channel"
            
            # Slack APIë¡œ ë©”ì‹œì§€ ì „ì†¡
            curl -X POST \
              -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
              -H "Content-type: application/json" \
              --data "{\"channel\":\"$channel\",\"text\":\"$MESSAGE\"}" \
              "https://slack.com/api/chat.postMessage"
          done
        else
          echo "Slack bot token or channels not configured"
        fi
        
    - name: Notify completion
      run: |
        echo "âœ… Daily news collection completed at $(date)"
        echo "ğŸ“° Check the latest news at: https://lumina-next-picker.vercel.app/news"
